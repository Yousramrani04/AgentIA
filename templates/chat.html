<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>AgentIA Chat</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; display:flex; height:100vh; background:#f4f7fa; }
    .sidebar { width:280px; background:#1e293b; color:#fff; padding:20px; overflow-y:auto; border-right:2px solid #334155; display:flex; flex-direction:column; }
    .sidebar h5 { margin-bottom:15px; font-weight:bold; color:#facc15; }
    .chat-container { flex:1; display:flex; flex-direction:column; background:#f1f5f9; }
    .messages { flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; }
    .input-area { display:flex; padding:15px; background:#fff; border-top:1px solid #ddd; }
    .input-area input { flex:1; padding:14px 20px; border-radius:30px; border:1px solid #ccc; outline:none; transition:border-color 0.3s; }
    .input-area input:focus { border-color:#4CAF50; }
    .input-area button { padding:12px 25px; margin-left:10px; border:none; border-radius:30px; background:#4CAF50; color:#fff; font-weight:bold; cursor:pointer; transition:background 0.3s; }
    .input-area button:hover { background:#45a049; }
    .msg { max-width:70%; padding:12px 18px; border-radius:25px; word-wrap:break-word; animation:fadeIn 0.3s ease; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .msg.user { background:linear-gradient(135deg,#a7f3d0,#6ee7b7); align-self:flex-end; color:#065f46; font-weight:500; }
    .msg.assistant { background:linear-gradient(135deg,#e0f2fe,#bae6fd); align-self:flex-start; color:#1e3a8a; font-size:1rem; line-height:1.5; }
    .msg.assistant b { color:#1e40af; }
    .msg.assistant span { padding:2px 6px; border-radius:5px; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(8px);} to {opacity:1; transform:translateY(0);} }
    .typing { display:flex; align-items:center; margin-bottom:10px; gap:4px; }
    .typing .dot { height:10px; width:10px; background-color:#4CAF50; border-radius:50%; animation:blink 1.4s infinite both; }
    .typing .dot:nth-child(2) { animation-delay:0.2s; }
    .typing .dot:nth-child(3) { animation-delay:0.4s; }
    @keyframes blink { 0%,100%{opacity:0.3;} 50%{opacity:1;} }
    #history { max-height:70vh; overflow-y:auto; display:flex; flex-direction:column-reverse; gap:8px; flex:1; }
    #history .msg { max-width:100%; font-size:0.85rem; background:#334155; color:#fff; box-shadow:none; }
    .logout-btn { margin-top:15px; padding:8px 12px; background:#dc2626; color:#fff; border:none; border-radius:20px; cursor:pointer; text-align:center; }
    .logout-btn:hover { background:#b91c1c; }
</style>
</head>
<body>
    <div class="sidebar">
        <h5>ðŸ“œ Historique</h5>
        <div id="history"></div>
        <!-- Bouton dÃ©connexion -->
        <a href="{{ url_for('logout') }}" class="logout-btn">Se dÃ©connecter</a>
    </div>
    <div class="chat-container">
        <div class="messages" id="messages"></div>
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Tapez votre message...">
            <button onclick="sendMessage()">Envoyer</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js"></script>
    <script>
        const messagesDiv = document.getElementById('messages');
        const historyDiv = document.getElementById('history');
        let typingDiv = null;

        function appendMessage(role, content) {
            if (typingDiv) { typingDiv.remove(); typingDiv = null; }
            const div = document.createElement('div');
            div.className = 'msg ' + role;
            div.innerHTML = DOMPurify.sanitize(content);
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showTyping() {
            typingDiv = document.createElement('div');
            typingDiv.className = 'typing';
            typingDiv.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function loadHistory() {
            const res = await fetch('/get_history');
            const data = await res.json();
            historyDiv.innerHTML = '';
            data.history.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'msg ' + msg.role;
                div.innerHTML = DOMPurify.sanitize(msg.content);
                historyDiv.appendChild(div);
            });
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const msg = input.value.trim();
            if(!msg) return;
            appendMessage('user', msg);
            input.value = '';
            showTyping();

            const res = await fetch('/send_message', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: msg})
            });
            const data = await res.json();
            if(data.reply){
                appendMessage('assistant', data.reply);
                loadHistory();
            }
        }

        // Charger l'historique au dÃ©marrage
        loadHistory();
    </script>
</body>
</html>
